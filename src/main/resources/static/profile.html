<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Profile ‚Äì Campus Event Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background-color: #f5faff;
            font-family: 'Segoe UI', sans-serif;
        }
        .container {
            max-width: 700px;
            margin-top: 40px;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
            margin-top: 10px;
        }
        .password-toggle {
            cursor: pointer;
            user-select: none;
        }
        .navbar {
            background-color: #e3f2fd !important;
        }
    </style>
</head>
<body class="bg-light">

<!-- Navbar -->
<nav class="navbar navbar-light bg-light justify-content-end px-4">
    <div>
        <a href="index.html" class="btn btn-outline-secondary me-2">Home</a>
    </div>
</nav>

<div class="container">
    <h2 class="mb-4">üë§ Your Profile</h2>
    <form id="profileForm">
        <label class="form-label" for="username">Username (cannot be changed)</label>
        <input type="text" class="form-control" id="username" readonly />

        <label class="form-label" for="email">Email (cannot be changed)</label>
        <input type="email" class="form-control" id="email" readonly />

        <!-- Verification button -->
        <div class="mb-3 mt-2" id="verificationContainer"></div>

        <label class="form-label" for="role">Role (cannot be changed)</label>
        <input type="text" class="form-control" id="role" readonly />

        <label class="form-label" for="firstName">First Name</label>
        <input type="text" class="form-control" id="firstName" required />

        <label class="form-label" for="lastName">Last Name</label>
        <input type="text" class="form-control" id="lastName" required />

        <label class="form-label" for="password">Password</label>
        <div class="input-group">
            <input type="password" class="form-control" id="password" placeholder="Leave blank to keep current password" />
            <button class="btn btn-outline-secondary password-toggle" type="button" id="togglePassword" tabindex="-1">
                üëÅÔ∏è
            </button>
        </div>

        <label class="form-label" for="course">Course</label>
        <select class="form-select" id="course" required>
            <option value="" disabled selected>Select your course</option>
            <option value="Computer Science">Computer Science</option>
            <option value="Business Administration">Business Administration</option>
            <option value="Psychology">Psychology</option>
            <option value="Engineering">Engineering</option>
            <option value="Biology">Biology</option>
            <option value="Economics">Economics</option>
            <option value="Mathematics">Mathematics</option>
            <option value="Political Science">Political Science</option>
            <option value="Nursing">Nursing</option>
            <option value="Education">Education</option>
        </select>

        <button type="submit" class="btn btn-success w-100 mt-4">üíæ Save Profile</button>
        <div id="updateMessage" class="mt-3"></div>
    </form>
</div>

<script>
    let currentPerson = null;

    // Load user profile
    async function loadProfile() {
        try {
            const res = await fetch('/api/current-user', { credentials: 'include' });
            if (!res.ok) throw new Error('Failed to fetch current user');
            currentPerson = await res.json();

            // Fill fields
            document.getElementById('username').value = currentPerson.username || '';
            document.getElementById('email').value = currentPerson.email || '';
            document.getElementById('role').value = currentPerson.role || '';
            document.getElementById('firstName').value = currentPerson.firstName || '';
            document.getElementById('lastName').value = currentPerson.lastName || '';
            document.getElementById('password').value = '';

            // Course dropdown
            const courseSelect = document.getElementById('course');
            const selectedCourse = currentPerson.course?.trim();
            if (selectedCourse) {
                const matchedOption = Array.from(courseSelect.options).find(opt => opt.value === selectedCourse);
                if (matchedOption) courseSelect.value = selectedCourse;
            }

            // Update verification button
            updateVerificationButton();

        } catch (err) {
            console.error(err);
            alert('Failed to load profile. Please try again later.');
        }
    }

    // Update profile
    async function updateProfile(personDTO) {
        const messageDiv = document.getElementById('updateMessage');
        messageDiv.textContent = '';
        messageDiv.className = '';

        try {
            const res = await fetch('/api/updatePerson', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(personDTO),
                credentials: 'include'
            });

            if (res.ok) {
                messageDiv.textContent = '‚úÖ Profile updated successfully.';
                messageDiv.className = 'text-success';
                await loadProfile();
            } else if (res.status === 404) {
                messageDiv.textContent = '‚ùå User not found.';
                messageDiv.className = 'text-danger';
            } else {
                const errText = await res.text();
                messageDiv.textContent = '‚ùå Update failed: ' + errText;
                messageDiv.className = 'text-danger';
            }
        } catch (err) {
            console.error(err);
            messageDiv.textContent = '‚ùå Error updating profile.';
            messageDiv.className = 'text-danger';
        }
    }

    // Verification button logic
    function updateVerificationButton() {
        const container = document.getElementById('verificationContainer');

        if (currentPerson.verified) {
            container.innerHTML = '<button type="button" class="btn btn-success w-100" disabled>‚úÖ Email Verified</button>';
        } else {
            container.innerHTML = `
            <button type="button" class="btn btn-warning w-100" id="sendVerificationBtn">
                üìß Send Verification Email
            </button>
            <div id="verificationMessage" class="mt-2"></div>
        `;

            document.getElementById('sendVerificationBtn').addEventListener('click', async () => {
                const messageDiv = document.getElementById('verificationMessage');
                messageDiv.textContent = '';
                messageDiv.className = '';

                try {
                    const res = await fetch(`/api/sendEmail?userId=${currentPerson.id}`, {
                        method: 'POST',
                        credentials: 'include'
                    });

                    if (res.ok) {
                        messageDiv.textContent = '‚úÖ Verification email sent! Please check your inbox.';
                        messageDiv.className = 'text-success';

                        // Poll server every 2 seconds to check if user is verified
                        const intervalId = setInterval(async () => {
                            const checkRes = await fetch('/api/current-user', { credentials: 'include' });
                            if (checkRes.ok) {
                                const updatedUser = await checkRes.json();
                                if (updatedUser.verified) {
                                    currentPerson.verified = true;
                                    updateVerificationButton(); // redraw button
                                    clearInterval(intervalId);
                                    messageDiv.textContent = '‚úÖ Email verified!';
                                    messageDiv.className = 'text-success';
                                }
                            }
                        }, 2000);

                    } else {
                        const text = await res.text();
                        messageDiv.textContent = '‚ùå Failed to send email: ' + text;
                        messageDiv.className = 'text-danger';
                    }
                } catch (err) {
                    console.error(err);
                    messageDiv.textContent = '‚ùå Error sending verification email.';
                    messageDiv.className = 'text-danger';
                }
            });
        }
    }


    // Event listeners
    document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!currentPerson) return alert('User data not loaded yet.');

        const updatedPerson = {
            id: currentPerson.id,
            username: currentPerson.username,
            email: currentPerson.email,
            verified: currentPerson.verified,
            role: currentPerson.role || 'USER',
            firstName: document.getElementById('firstName').value.trim(),
            lastName: document.getElementById('lastName').value.trim(),
            password: document.getElementById('password').value.trim(),
            course: document.getElementById('course').value.trim(),
        };

        await updateProfile(updatedPerson);
    });

    // Toggle password visibility
    document.getElementById('togglePassword').addEventListener('click', () => {
        const pwdInput = document.getElementById('password');
        pwdInput.type = pwdInput.type === 'password' ? 'text' : 'password';
    });

    // Load profile on page load
    window.addEventListener('DOMContentLoaded', loadProfile);
</script>

</body>
</html>
