<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Campus Events</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        body {
            background-color: #f5faff;
            font-family: 'Segoe UI', sans-serif;
        }
        .navbar {
            background-color: #e3f2fd !important;
        }
        .hero {
            background-color: #ffffff;
            padding: 4rem 2rem;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }
        .hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #0077b6;
        }
        .hero p {
            color: #495057;
        }
        .btn-outline-secondary {
            border-color: #74c0fc;
            color: #0077b6;
        }
        .btn-outline-secondary:hover {
            background-color: #d0ebff;
            color: #005fa3;
        }
        .btn-outline-primary {
            border-color: #91d5ff;
        }
        .btn-outline-primary:hover {
            background-color: #bae0ff;
        }
        .btn-outline-dark:hover {
            background-color: #dee2e6;
        }
    </style>
</head>
<body class="bg-light">

<!-- ✅ Navbar -->
<nav class="navbar navbar-light bg-light justify-content-end px-4" id="navbar">
    <div id="navbar-links"></div>
</nav>

<div class="container py-5">
    <h1 class="mb-4 text-center text-primary">Campus Event Explorer</h1>

    <!-- Filters -->
    <div class="mb-4 d-flex justify-content-center align-items-center flex-wrap gap-2">
        <button class="btn btn-primary" onclick="getAllEvents()">Get All Events</button>
        <input type="text" id="locationInput" class="form-control w-auto" placeholder="Start typing location">
        <input type="date" id="dateInput" class="form-control w-auto" onchange="getEventsByDate()" />
    </div>



    <!-- Results Panel -->
    <div id="results" class="border p-4 bg-white rounded shadow-sm mx-auto text-center" style="max-width: 700px;">
        <p class="text-muted">Results will appear here...</p>
    </div>

</div>

<!-- ✅ Scripts -->
<script src="/js/auth.js"></script>
<script>
    const apiBase = "/api";

    async function getAllEvents() {
        const res = await fetch(`${apiBase}/getAllEvents`);
        const data = await res.json();
        renderResults(data, "All Events");
    }

    let typingTimer;
    const typingDelay = 300; // ms debounce so it doesn't spam server
    const locationInput = document.getElementById("locationInput");

    locationInput.addEventListener("input", () => {
        clearTimeout(typingTimer);
        typingTimer = setTimeout(async () => {
            const location = locationInput.value.trim();
            if (location.length === 0) {
                document.getElementById("results").innerHTML = `<p class="text-muted">Results will appear here...</p>`;
                return;
            }

            const res = await fetch(`${apiBase}/findByLocationPart?location=${encodeURIComponent(location)}`);
            const data = await res.json();
            renderResults(data, `Matching "${location}"`);
        }, typingDelay);
    });


    async function getEventsByDate() {
        const input = document.getElementById("dateInput").value;
        if (!input) return alert("Please select a date.");
        const res = await fetch(`${apiBase}/getEventsByDate/${encodeURIComponent(input)}`);
        const data = await res.json();
        const dateObj = new Date(input);
        const formattedDate = `${dateObj.getDate().toString().padStart(2, '0')}/${(dateObj.getMonth() + 1).toString().padStart(2, '0')}/${dateObj.getFullYear()}`;
        renderResults(data, `Events on ${formattedDate}`);
    }

    function renderResults(events, title) {
        const container = document.getElementById("results");
        if (!events || events.length === 0) {
            container.innerHTML = `<h4>${title}</h4><p class="text-danger">No events found.</p>`;
            return;
        }

        container.innerHTML = `<h4>${title}</h4>`;

        // Check login status from localStorage
        let loggedIn = false;
        try {
            const user = JSON.parse(localStorage.getItem("currentUser"));
            loggedIn = user && user.id ? true : false;
        } catch(e) {
            loggedIn = false;
        }

        events.forEach(event => {
            // If logged in, wrap event title in a link; else just plain text
            const eventTitleHTML = loggedIn
                ? `<a href="event.html?id=${event.id}" class="text-decoration-none">${event.title}</a>`
                : `<span class="text-muted">${event.title} (Login to view)</span>`;

            container.innerHTML += `
            <div class="mb-4 p-3 border-bottom text-center">
                <h5 class="fw-bold">${eventTitleHTML}</h5>
                <p><strong>Location:</strong> ${event.location}</p>
                <p><strong>Date:</strong> ${new Date(event.date).toLocaleDateString('en-GB')}</p>
            </div>
        `;
        });
    }




    // Setup dynamic navbar & redirect when DOM is ready
    document.addEventListener("DOMContentLoaded", async () => {
        const nav = document.getElementById("navbar-links");
        try {
            const res = await fetch("/api/current-user", { credentials: "include" });
            if (!res.ok) throw new Error("Not logged in");
            const user = await res.json();

            if (user) {
                localStorage.setItem("currentUser", JSON.stringify(user));
                localStorage.setItem("username", user.username);
                localStorage.setItem("customerId", user.id);

                nav.innerHTML = `
                    ${user.role === 'ADMIN' ? '<a href="admin.html" class="btn btn-outline-danger me-2">Admin</a>' +
                    '<a href="log.html" class="btn btn-outline-warning me-2">Logs</a>' : ''}
                    <a href="profile.html" class="btn btn-outline-primary me-2">Profile</a>
                    <a href="myEvents.html" class="btn btn-outline-primary me-2">My events</a>
                    <button onclick="logout()" class="btn btn-outline-danger">Logout</button>
                `;

                // Redirect if on login or register page
                const pathname = window.location.pathname;
                if (pathname.endsWith("login.html") || pathname.endsWith("register.html")) {
                    window.location.href = "profile.html";
                }
            } else {
                nav.innerHTML = `
                    <a href="login.html" class="btn btn-outline-primary me-2">Login</a>
                    <a href="register.html" class="btn btn-outline-success">Register</a>
                `;

                // Redirect if trying to access profile without login
                if (window.location.pathname.endsWith("profile.html")) {
                    alert("Please login to access your profile.");
                    window.location.href = "login.html";
                }
            }
        } catch (err) {
            nav.innerHTML = `
                <a href="login.html" class="btn btn-outline-primary me-2">Login</a>
                <a href="register.html" class="btn btn-outline-success">Register</a>
            `;

            if (window.location.pathname.endsWith("profile.html")) {
                alert("Please login to access your profile.");
                window.location.href = "index.html";
            }
        }
    });

    async function logout() {
        await fetch("/api/logout", { method: "POST", credentials: "include" });
        localStorage.clear();
        window.location.href = "index.html";
    }
</script>

</body>
</html>
